# **数据库设计：多值依赖与第四范式（4NF）详解**

## **1. 多值依赖（Multivalued Dependency, MVD）**
### **1.1 基本概念**
- **定义**：给定关系模式 R(X, Y, Z)，若对 R 的任意两个元组 t₁ 和 t₂，若 t₁[X] = t₂[X]，则必然存在元组 t₃ 和 t₄ 使得：
  - t₃[X] = t₄[X] = t₁[X] = t₂[X]
  - t₃[Y] = t₁[Y], t₃[Z] = t₂[Z]
  - t₄[Y] = t₂[Y], t₄[Z] = t₁[Z]
- **符号表示**：X ↠ Y（X 多值决定 Y）
- **直观理解**：X 值确定后，Y 和 Z 的值可以独立变化（Y 和 Z 相互独立）

### **1.2 示例分析**
```
Teaching(Course, Teacher, Textbook)
----------------------------------
Math    | Alice  | Book1
Math    | Alice  | Book2
Math    | Bob    | Book1
Math    | Bob    | Book2
```
- **MVD**：
  - Course ↠ Teacher
  - Course ↠ Textbook
- **解释**：
  - 每门课程（Course）对应一组教师（Teacher）和一组教材（Textbook）
  - 教师和教材是独立的（Alice可以使用Book1或Book2）

### **1.3 与函数依赖（FD）的区别**
| 特性                | 函数依赖 (FD)          | 多值依赖 (MVD)          |
|---------------------|-----------------------|------------------------|
| **表示符号**         | X → Y                | X ↠ Y                 |
| **决定关系**         | X 唯一确定 Y          | X 确定 Y 的多值集合     |
| **数据冗余**         | 导致更新异常          | 导致组合爆炸            |
| **范式要求**         | 3NF/BCNF 消除        | 4NF 消除              |

## **2. 第四范式（4NF）**
### **2.1 定义**
- **核心要求**：
  1. 满足 BCNF
  2. **消除非平凡多值依赖**（即 X ↠ Y 中，Y 不是 X 的子集，且 X ∪ Y ≠ R）
- **本质**：确保表中不存在"一对多"的独立关系

### **2.2 违反4NF的典型案例**
```
Course_Info(Course, Teacher, Textbook)
--------------------------------------
Math    | Alice  | Book1
Math    | Alice  | Book2
Math    | Bob    | Book1
Math    | Bob    | Book2
```
- **问题**：
  - 数据冗余：教师和教材的组合会指数增长（如果有n个教师和m本教材，需要n×m行）
  - 更新异常：增加一个新教师需要为每本教材添加记录

### **2.3 规范化步骤**
1. **识别MVD**：
   - Course ↠ Teacher
   - Course ↠ Textbook
2. **分解原则**：
   - 对每个MVD X ↠ Y，分解为：
     - R1(X, Y)
     - R2(X, Z) 其中 Z = R - (X ∪ Y)
3. **应用分解**：
   - Courses_Teachers(Course, Teacher)
   - Courses_Textbooks(Course, Textbook)

**分解结果**：
```
Courses_Teachers          Courses_Textbooks
-----------------         -----------------
Course  | Teacher        Course  | Textbook
Math    | Alice          Math    | Book1
Math    | Bob            Math    | Book2
```

### **2.4 4NF的判定条件**
- 检查所有非平凡MVD是否都满足：
  - X 是超键（即 X 包含候选键）
- 若不满足，则需要分解

## **3. 连接依赖与第五范式（5NF）**
### **3.1 连接依赖（Join Dependency）**
- **定义**：关系 R 满足连接依赖 *{R1, R2, ..., Rn}*，当且仅当 R 等于这些子关系的自然连接
- **特殊形式**：当 n=2 时，就是无损连接分解
- **与MVD关系**：每个 MVD X ↠ Y 对应一个连接依赖 *{XY, X(R-Y)}*

### **3.2 第五范式（5NF）/投影-连接范式（PJNF）**
- **核心要求**：
  1. 满足4NF
  2. **所有连接依赖都隐含于候选键中**
- **实际意义**：消除那些不能通过FD或MVD推导出的连接依赖

### **3.3 5NF应用场景**
```
Supplies(Seller, Product, Customer)
----------------------------------
Ace    | Bolt   | Alex
Ace    | Nut    | Bob
Best   | Bolt   | Bob
Best   | Nut    | Alex
```
- **JD**：*{(Seller, Product), (Product, Customer), (Customer, Seller)}*
- **问题**：
  - 不能通过FD或MVD推导出这种三元关系
  - 需要满足"如果Ace卖Bolt给Alex，且Ace卖Nut给Bob，且Best卖Bolt给Bob，则Best必须卖Nut给Alex"
- **解决方案**：
  - 通常保持原表结构（因为5NF分解会丢失语义信息）

## **4. 考试重点与解题技巧**
### **4.1 如何判断4NF？**
1. 检查是否满足BCNF
2. 找出所有非平凡MVD（X ↠ Y）
3. 验证X是否是超键：
   - 若是，满足4NF
   - 若否，需要分解

### **4.2 典型考题解析**
**题目**：
关系 R(A, B, C, D) 满足：
- A ↠ B
- C ↠ D
- 候选键：AC

**问题**：是否满足4NF？如何分解？

**解答**：
1. 检查MVD：
   - A ↠ B：A 不是超键（候选键是AC）
   - C ↠ D：C 不是超键
2. 需要分解：
   - 对 A ↠ B 分解为 R1(A, B) 和 R2(A, C, D)
   - 检查 R2：仍有 C ↠ D，继续分解为 R21(C, D) 和 R22(A, C)
3. 最终分解：
   - R1(A, B)
   - R21(C, D)
   - R22(A, C)

### **4.3 5NF判定要点**
- 检查是否存在"隐式"的三元或多元关系
- 通常考题会明确给出连接依赖条件
- 实际应用中，5NF分解较少使用（可能破坏业务语义）

## **5. 总结对比**
| 范式  | 解决的核心问题               | 依赖类型           | 判定关键                     |
|-------|----------------------------|-------------------|----------------------------|
| 1NF   | 数据原子性                  | -                 | 属性是否可再分               |
| 2NF   | 部分函数依赖                | 部分FD            | 非主属性是否完全依赖候选键    |
| 3NF   | 传递函数依赖                | 传递FD            | 非主属性是否依赖其他非主属性  |
| BCNF  | 非候选键决定的函数依赖       | 所有FD            | 决定因素是否都是候选键        |
| 4NF   | 非平凡多值依赖              | MVD               | X ↠ Y 中X是否是超键         |
| 5NF   | 非隐含的连接依赖             | 连接依赖           | 连接依赖是否由候选键隐含      |

**重要结论**：
- 4NF解决的是"独立多值属性"导致的组合爆炸问题
- 5NF处理的是更复杂的多元关系约束
- 实际数据库设计通常到BCNF或4NF即可
